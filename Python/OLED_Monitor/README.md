# OnBoard OLED Monitor v1.4 - Request-Response Protocol with RAW Data Logging

STM32 OnBoard LED Timer의 1.3" OLED 디스플레이를 실시간으로 모니터링하는 도구입니다.

## 🚀 새로운 기능 (v1.4)

### 요청-응답 프로토콜
- **펌웨어**: 자동 전송 없음, 명령어 요청시에만 응답
- **모니터링 도구**: 사용자 설정 주기마다 GET_SCREEN 명령 전송
- **효율성**: CPU 사용률 최적화, 데이터 충돌 방지

### RAW 데이터 로깅 시스템 🔍
- **완전한 데이터 보존**: 파싱 전 원본 데이터 모두 기록
- **이중 로그 시스템**: 상태 로그 + RAW 데이터 전용 로그
- **디버깅 지원**: 통신 오류 시 정확한 원인 분석 가능
- **HEX 형식 저장**: 바이너리 데이터의 정확한 기록

### 지원 명령어
- `GET_SCREEN`: 화면 데이터 요청
- `GET_STATUS`: 상태 정보 요청  
- `SET_UPDATE_MODE:REQUEST_RESPONSE,100`: 요청-응답 모드 설정
- `START_MONITOR`: 모니터링 시작 (요청-응답 방식)
- `STOP_MONITOR`: 모니터링 중지

## 🔧 설치 및 실행

### 실행 방법 (권장 순서)

#### 방법 1: 자동 실행기 (권장)
```bash
run_monitor.bat
```
- 가상환경 자동 생성 및 패키지 자동 설치
- 완전 자동화된 실행 환경 구성

#### 방법 2: 간단 실행기 (문제시 사용)
```bash
run_monitor_simple.bat
```
- 기본 기능만 포함한 간소화된 버전
- 메인 스크립트에 문제가 있을 때 사용

#### 방법 3: 직접 실행 (비상용)
```bash
run_direct.bat
```
- 가상환경 없이 시스템 Python 직접 사용
- 가상환경 생성에 문제가 있을 때 사용

### 요구사항
```bash
pip install -r requirements.txt
```

## 📊 로그 시스템

### 로그 파일 구조
```
LOG/
├── status_log_YYYYMMDD.txt      # 상태 정보 종합 로그
└── raw_data_log_YYYYMMDD.txt    # RAW 데이터 전용 로그
```

### 상태 로그 형식 (status_log_YYYYMMDD.txt)
```
시간            배터리  타이머    상태      L1   L2   비고        RAW 데이터
14:30:25.123    85%    05:30    RUNNING   연결  해제  firmware    STATUS:BAT:85%,TIMER:05:30...
14:30:26.456    84%    05:29    RUNNING   연결  해제  firmware    STATUS:BAT:84%,TIMER:05:29...
14:30:27.789    [SCREEN_CAPTURE_SUCCESS] 화면 캡처 성공 (1024 bytes) [RAW: 100bytes]
```

### RAW 데이터 로그 형식 (raw_data_log_YYYYMMDD.txt)
```
시간            데이터 타입       길이    RAW 데이터 (HEX)
14:30:25.123    STATUS           45      5354415455533A4241543A38352...
14:30:26.456    SCREEN_CAPTURE   1024    3C3C534352454E5F535441525...
14:30:27.789    EVENT_CONNECT    25      504F52543A434F4D332C424155...
```

### 로그 이벤트 타입
- **STATUS**: 상태 데이터 파싱 결과
- **SCREEN_CAPTURE_SUCCESS/FAIL**: 화면 캡처 성공/실패
- **EVENT_CONNECT**: 연결 이벤트
- **EVENT_DISCONNECT**: 연결 해제
- **SERIAL_ERROR**: 시리얼 통신 오류
- **PARSING_FAILED**: 데이터 파싱 실패
- **SIZE_MISMATCH**: 데이터 크기 불일치

## 🎮 사용법

### 1. 연결 설정
1. **포트 선택**: COM3 (Windows) 또는 /dev/ttyUSB0 (Linux)
2. **보드레이트**: 921600 (권장)
3. **연결** 버튼 클릭

### 2. 갱신 주기 설정
- **50ms**: 20 FPS (부드러운 화면, 권장)
- **100ms**: 10 FPS (균형)
- **200ms**: 5 FPS (저전력)
- **500ms~2000ms**: 저속 모니터링

### 3. 자동 모니터링
1. **갱신 주기(ms)** 설정
2. **자동 화면 요청** 체크박스 활성화
3. **모니터링 시작** 버튼 클릭

### 4. 동작 흐름
```
1. 연결 → 2. 갱신 주기 설정 → 3. 자동 요청 활성화 → 4. 모니터링 시작
                ↓
펌웨어: REQUEST_RESPONSE 모드로 전환
                ↓
도구: 설정된 주기마다 GET_SCREEN 명령 전송
                ↓
펌웨어: 요청시에만 화면 데이터 응답
                ↓
도구: 화면 표시 + RAW 데이터 로그 기록
```

## 📋 지원 기능

### 기본 기능
- ✅ 요청-응답 기반 화면 캡처
- ✅ 사용자 정의 갱신 주기 (50ms~2000ms)
- ✅ 실시간 성능 통계
- ✅ 화면 저장 (PNG, 고해상도 지원)
- ✅ 상태 정보 모니터링

### RAW 데이터 로깅
- ✅ 파싱 전 원본 데이터 완전 보존
- ✅ HEX 형식 정확한 기록
- ✅ 통신 오류 완전 추적
- ✅ 디버깅 정보 상세 기록
- ✅ 이벤트별 RAW 데이터 분류

### 원격 제어
- ✅ 타이머 시작/중지
- ✅ 타이머 시간 설정
- ✅ 시스템 리셋
- ✅ 연결 테스트

### 고급 기능
- ✅ 다양한 파싱 방법 지원
- ✅ 자동 저장 기능
- ✅ 세션 기록
- ✅ 로그 시스템 (중복 방지)

## 🔍 RAW 데이터 분석

### HEX 데이터 해석 예시
```
5354415455533A4241543A38352C54494D45523A30353A33302C5354415455533A52554E4E494E472C4C313A312C4C323A30

ASCII 변환: STATUS:BAT:85,TIMER:05:30,STATUS:RUNNING,L1:1,L2:0
```

### 통신 오류 분석
```
# 불완전한 데이터 수신
3C3C534352454E5F535441525...  (<<SCREEN_START 시작)
# → SCREEN_END 마커 누락 확인 가능

# 체크섬 불일치
예상: CHECKSUM:ABCD1234
실제: CHECKSUM:EFGH5678
# → 데이터 손상 정확히 추적
```

### 로그 활용 방법
1. **성능 분석**: 성공률, 응답 시간 통계
2. **오류 진단**: 통신 실패 원인 분석  
3. **데이터 복구**: 손상된 패킷 복구 시도
4. **프로토콜 검증**: 펌웨어-PC 간 통신 정확성 확인

## 🛠️ 문제 해결

### 자주 발생하는 문제들

#### 1. Python import 오류
```
'import' is not recognized as an internal or external command
```

**해결방법:**
1. `run_monitor_simple.bat` 사용
2. Python PATH 설정 확인
3. 관리자 권한으로 실행

#### 2. RAW 데이터 로그 파일 크기 증가
- **정상**: 하루 10-50MB (일반 사용)
- **주의**: 100MB 이상 (빈번한 오류 발생)
- **해결**: 로그 파일 주기적 정리 또는 압축

#### 3. 통신 오류 빈발
1. **로그 확인**: `raw_data_log_YYYYMMDD.txt`에서 오류 패턴 분석
2. **케이블 점검**: USB 케이블 및 연결 상태
3. **보드레이트**: 921600에서 115200으로 변경 시도

## 🔄 업데이트 내용 (v1.4)

### 주요 개선
- 🔄 **요청-응답 프로토콜**: 펌웨어 자동 전송 제거
- 🔍 **RAW 데이터 로깅**: 완전한 통신 데이터 보존
- ⚡ **CPU 최적화**: 효율적인 요청 스케줄링
- 📊 **성능 통계**: 실시간 FPS 및 성공률 표시
- 🛡️ **안정성 강화**: 연속 실패 감지 및 복구
- 🎛️ **사용자 제어**: 갱신 주기 실시간 조절

### 로깅 시스템 강화
- **이중 로그**: 상태 + RAW 데이터 분리 기록
- **HEX 형식**: 바이너리 데이터 정확한 보존
- **이벤트 분류**: 연결, 오류, 성공 등 상세 분류
- **디버깅 지원**: 모든 통신 과정 완전 추적

### 호환성
- ✅ 펌웨어 v1.4 이상 필요
- ✅ 기존 파싱 방법 모두 지원
- ✅ 이전 버전 설정 호환

---

**Author**: OnBoard LED Timer Project  
**Version**: 1.4 - Request-Response Protocol with RAW Data Logging  
**Date**: 2024-01-01 